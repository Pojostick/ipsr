$(function(){function o(o){var t=parseInt(o).toString(16);return 1==t.length?"0"+t:t}function t(t){return t=t.split(/[^\d]+/).slice(1,4),"#"+o(t[0])+o(t[1])+o(t[2])}submitbutton=$("#submitbutton").detach(),submitbutton.appendTo($("#menubar"));var r=$("#APPDATA").attr("mosaic_id"),a=0;autosave=function(o,e,i){o!=e&&(i.replace(" ",""),"rgba"==i.substring(0,4)&&(i="transparent"),"rgb"==i.substring(0,3)&&(i=t(i)),console.log(c),$.ajax({type:"POST",url:"/mosaics/autosave",data:{mosaic_id:r,index:a++,tileFrom:o,tileTo:e,color:i,time_left:c}}))},$(".centerer").droppable({drop:function(o,t){"src"!=t.draggable[0].id.substring(0,3)&&(console.log(a+": Cleared "+t.draggable[0].id+" of "+t.draggable.css("background-color")),t.draggable.css("background-color",""),autosave(t.draggable[0].id,-1,"transparent"))}}),$(".mosaic table").droppable({greedy:!0}),$(".mosaic .block").draggable({helper:"clone",cursor:"move",cursorAt:{top:25,left:25},opacity:.75}).addClass("ui-widget-content").droppable({hoverClass:"glow",drop:function(o,t){"src"==t.draggable[0].id.substring(0,3)?(console.log(a+": Changed "+$(this)[0].id+" from "+$(this).css("background-color")+" to "+t.draggable.css("background-color")),$(this).css("background-color",t.draggable.css("background-color")),autosave(-1,$(this)[0].id,t.draggable.css("background-color"))):(console.log(a+": Swapped "+$(this)[0].id+" and "+t.draggable[0].id+" switching "+$(this).css("background-color")+" with "+t.draggable.css("background-color")),autosave(t.draggable[0].id,$(this)[0].id,t.draggable.css("background-color")),$(this).css("background-color",t.draggable.css("background-color")),t.draggable.css("background-color",""))},greedy:!0,tolerance:"pointer"}),$(".selection .block").draggable({helper:"clone",cursor:"move",cursorAt:{top:25,left:25},opacity:.75}).addClass("ui-widget-content");var e=function(o){$(".block").draggable("disable"),$("#timer").text("Submitting..."),$("#timer-bar").progressbar("value",0),$("#timer-bar > div").css("background-color",o),hide_time=show_time=function(){}};submit=function(o){c!=-1&&($.ajax({type:"POST",url:"/mosaics/autosave",data:{mosaic_id:r,time_taken:Math.round((i-c)/60)}}),c=-1,e("#fb8"),$("#timer").css("cursor","wait"),clearTimeout(timer),alert((o?"Time's up. Thanks for completing":"Thanks for submitting")+" your mosaic!"),window.location.href="/mosaics/"+r)};var i=60*parseInt($("#APPDATA").attr("time_total")),s=parseInt($("#APPDATA").attr("time_left")),c=s,n=Date.now();hide_time=function(){$("#timer").text("Submit"),$("#timer-bar").progressbar("value",100)},show_time=function(){$("#timer").text(Math.floor(c/60)+":"+(c%60<10?"0":"")+c%60),$("#timer-bar").progressbar("value",c/(i/100))};var l=hide_time;$("#timer-bar").progressbar(),$("#timer-bar").hover(function(){(l=show_time)()},function(){(l=hide_time)()}),timer=setTimeout(function o(){c>0?(c=s-Math.floor((Date.now()-n)/1e3),timer=setTimeout(o,1e3),l()):s>0&&submit(!0)},0),0==s&&(e("#afa"),$("#timer").text("Submitted."),submit=function(){window.location.href="/mosaics/"+r})});